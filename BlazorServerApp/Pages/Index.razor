@page "/"
@using BlazorServerApp.Services
@using System.Security.Claims
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject AuthenticationStateProvider authenticationStateProvider
@inject ProjectManagementService projectManagementService
@inject NavigationManager navigationManager

<PageTitle>Index</PageTitle>

<div class="landing-container">
	<div class="top-navbar">
		<div class="home">

		</div>

		<div class="profile">

		</div>
	</div>
	<div class="create-new-env-container">
		<button class="create-new-env" @onclick="OpenModal">
			Create a new environment
		</button>
	</div>
	<div class="recent-envs-container">
		<h2>Recent environments</h2>
		<div class="list-of-recent-envs">

		</div>
		<a class="see-all-envs" href="/projects">
			See all environments
		</a>
	</div>


	@if (isModalVisible)
	{
		<CreateProjectModal @bind-Visible="isModalVisible" ProjectCreated="HandleProjectCreated" />
	}
</div>

@code {
	private bool isModalVisible = false;
	private void OpenModal()
	{
		isModalVisible = true;
	}
	private async Task HandleProjectCreated(CreateProjectModal.ProjectCreatedEventArgs args)
	{
		try
		{
			int projectId = await projectManagementService.CreateProjectAsync(args);
			if (projectId >= 0)
			{
				navigationManager.NavigateTo($"/project/{projectId}");
			}
			else if (projectId == -1)
			{
				navigationManager.NavigateTo("/login");
			}
			else
			{
				Console.WriteLine("Error creating project");
			}
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error creating project: {ex.Message}");
		}
		finally
		{
			isModalVisible = false;
		}
	}
}

@using Microsoft.AspNetCore.Components
@using BlazorMonaco
@using BlazorMonaco.Editor
@using BlazorMonaco.Languages
@implements IDisposable

<StandaloneCodeEditor Id="@ProjectId.ToString()" ConstructionOptions="editorConstructionOptions" OnDidChangeModelContent="OnInput"/>
@code {
	[Parameter]
	public int ProjectId { get; set; }
	[Parameter]
	public string CodeContent { get; set; }

	[Parameter]
	public EventCallback<string> CodeContentChanged { get; set; }
	
	[Parameter]
	public string Language { get; set; }

	private StandaloneCodeEditor standaloneEditor;
	private StandaloneEditorConstructionOptions editorConstructionOptions (StandaloneCodeEditor editor)
	{
		return new StandaloneEditorConstructionOptions
			{
				Language = GetMonacoLanguage(Language),
				AutomaticLayout = true,
				Value = CodeContent
			};
	}

	private Timer debounceTimer;

	private void OnInput()
	{
		const int SECOND_MS = 1000;
		debounceTimer?.Dispose();
		debounceTimer = new Timer(SaveCode, null, 1 * SECOND_MS, Timeout.Infinite);
	}
	private async void SaveCode(object state)
	{
		CodeContent = await standaloneEditor.GetValue();
		await CodeContentChanged.InvokeAsync(CodeContent);
	}
	private string GetMonacoLanguage(string language)
	{
		return language switch
		{
			"Java" => "java",
			"C++" => "cpp",
			"C" => "c",
			_ => "plaintext"
		};
	}
	public void Dispose()
	{
		debounceTimer?.Dispose();
	}
}

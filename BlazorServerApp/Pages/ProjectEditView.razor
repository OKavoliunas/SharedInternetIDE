@page "/project/{ProjectId:int}"
@inject ProjectDbService projectDbService
@inject AuthenticationStateProvider authenticationStateProvider
@inject UserFileService userFileService
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using BlazorServerApp.Services
@using BlazorServerApp.Models
<CodeEditor ProjectId="@ProjectId" @bind-CodeContent="codeContent" Language="@language"/>
@code {
	[Parameter]
	public int ProjectId { get; set; }

	private string codeContent;
	private Project currentProject;
	private string language;

	protected override async Task OnInitializedAsync()
	{
		var authState = await authenticationStateProvider.GetAuthenticationStateAsync();
		var user = authState.User;
		var userId = user.FindFirstValue(ClaimTypes.NameIdentifier);


		if (await projectDbService.IsProjectOwnedByUser(userId, ProjectId))
	{
			string selectedFileName = "";
			currentProject = await projectDbService.GetProjectById(ProjectId);
			List<string> fileNames = await userFileService.GetProjectFileNames(userId,ProjectId);
			bool isFirst = true;
			foreach (string	fileName in fileNames)
			{
				if (isFirst)
				{
					selectedFileName = fileName;
					isFirst = false;	
				}
				if (fileName == currentProject.Name + GetExtension(currentProject))
					selectedFileName = fileName;

			}
			if (!string.IsNullOrEmpty(selectedFileName))
			{
				language = currentProject.Language;

				codeContent = await userFileService.GetFileContentAsync(userId, ProjectId, selectedFileName);
			}
		}
			
		else
		{
			//TODO: Redirect to a page for no authorization
		}

	}
	private string GetExtension(Project project)
	{
		return project.Language switch
		{
			"Java" => ".java",
			"C" => ".c",
			"C++" => ".cpp",
			_ => "."
		};
	}
}
